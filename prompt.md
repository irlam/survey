
You are a coding agent working inside a NEW repository from scratch.

## Product summary
Build a **mobile-first construction plan survey app** that lets users:
- Upload and view plan PDFs (PDF.js viewer)
- Place and manage issues as numbered pins on drawings (normalized coordinates)
- Attach photos to issues and generate survey reports
- Work offline as a PWA (IndexedDB + sync queue)
- Manage a file vault (reference docs) with offline download
- Use advanced PDF tools (Merge/Split/Crop/Convert/Print/Batch Print) and manage all outputs as “Exports”
- Support **Projects (drawing sets)** and **Non-destructive Revisions** so originals remain intact for the next user

Primary target device: **Android tablet / mobile Chrome**.
Desktop support is “nice”, but mobile UX must be excellent.

## Hard rules (do not violate)
- **No Docker**. No container assumptions.
- **No Node build step** required to deploy. (Pure PHP + static assets)
- Use **Composer** for PHP dependencies and commit `composer.json` (do not commit secrets).
- Use **MySQL/MariaDB** with **PDO prepared statements**.
- All API endpoints return **JSON** and use proper HTTP status codes.
- Storage folders must be writable and **never committed** (keep `.gitkeep` only).
- Work in **small commits** with clear messages.
- After each milestone, update `docs/milestones.md` status table and add evidence links.

---

# 0) Repository setup (first commits)

## Folder structure
Create this structure (mobile-first, no-build):

/api
  config.sample.php
  config-util.php
  db.php
  ping.php
  ...endpoints...
/app
  app.js
  router.js
  viewer.js
  overlay.js
  idb.js
  sync.js
  ui.js
/assets
  ui.css
  icons/ (optional if you prefer /icons at root)
  ...images...
/icons               (PWA icons, include 192/512 + maskable)
/sql
  001_init.sql
  002_issues.sql
  003_photos.sql
  004_files.sql
  005_exports.sql
  006_audit.sql
  007_projects_revisions.sql
/storage
  .gitkeep
  plans/.gitkeep
  photos/.gitkeep
  files/.gitkeep
  exports/.gitkeep
  tmp/.gitkeep
/docs
  milestones.md
  AGENT.md
  QA_REPORT.md       (generated by agent)
  SMOKE_TESTS.md     (generated by agent)
/tools
  merge.html
  split.html
  crop.html
  convert.html
  print.html
  batch-print.html
/help.html
/exports.html
/index.html
/manifest.json
/service-worker.js

## Git ignore
Add `.gitignore` to exclude:
- `/storage/**` (but keep `.gitkeep`)
- `/api/config.php`
- `/vendor/` (optional — see composer note below)
- local OS/editor files

### Composer note
Default: do NOT commit `/vendor` to git.
Deployment expects running `composer install` on server OR building locally and uploading vendor manually.
Document both options in README.

---

# 1) Composer dependencies (PHP 8.x compatible)

Add `composer.json` with:
- setasign/fpdf (or fpdf/fpdf if preferred)
- setasign/fpdi (for import/merge/split)
- (optional) ext-gd for thumbnails
- (optional) ext-imagick for PDF raster/convert features (feature-gated)
- (optional) symfony/http-foundation is NOT required (keep minimal)

Use PHP built-ins for:
- ZipArchive (survey pack, split ZIP, convert ZIP)

Important: gate optional features if Imagick is missing.

---

# 2) Shared config + DB helper (required foundation)

Create:
- `api/config.sample.php` with:
  - db_host, db_name, db_user, db_pass, db_charset
  - base_url (optional)
  - storage_path (optional; default ../storage)
  - max_upload_mb
  - actor_name (for audit)
- `api/config-util.php`:
  - load_config(): reads `api/config.php` if present, else empty array
  - resolve_storage_path($config): absolute path
  - storage_dir($subpath): helper to join/ensure dirs
- `api/db.php`:
  - db(): PDO using config
  - json_response($data, $status=200)
  - require_method('POST'|'GET')
  - read_json_body()
  - safe_int($key)
  - error_response($msg, $status)

Create `api/ping.php`:
- JSON includes ok, timestamp, storage writable flags, php version.

---

# 3) Documentation baseline

Create:
- `README.md` with:
  - Requirements (PHP version, extensions, MySQL)
  - Setup without Docker:
    1) Create DB
    2) Import SQL migrations (in order)
    3) Copy `api/config.sample.php` → `api/config.php`
    4) `composer install`
    5) Ensure `storage/` writable
  - Upload limits notes (php.ini)
  - Endpoints list + troubleshooting

Create /docs:
- `docs/milestones.md` (see milestone section below)
- `docs/AGENT.md` with workflow rules

---

# Milestones (implement in order)

## Milestone 1 — Scaffold + storage + ping + config + init SQL + README
Deliver:
- storage layout, gitignore
- config sample + util
- db helper
- ping endpoint
- sql/001_init.sql with base tables (at minimum `plans`)
- README

Acceptance:
- GET /api/ping.php => ok:true and writable storage.

---

## Milestone 2 — Plans CRUD + Plan library + PDF.js viewer (mobile-first)

### Backend
DB: `plans` table (sql/001_init.sql):
- id, name, revision, file_path, sha1, uploaded_at

Storage:
- `storage/plans/` for PDFs
- `storage/.htaccess` with `Options -Indexes`

API endpoints (JSON):
- POST `/api/upload_plan.php` (multipart: file,name,revision)
  - validate PDF (mime + extension + signature best effort)
  - random filename
  - sha1
  - insert DB
- GET `/api/list_plans.php` (newest first)
- GET `/api/get_plan.php?plan_id=...` returns plan + `pdf_url`
- GET `/api/plan_file.php?plan_id=...` streams PDF safely (recommended), Range support if feasible.

### Frontend
- Default view: Plan library list + upload form
- Open plan: viewer view (query param plan_id)
- PDF.js viewer:
  - next/prev, page X/Y
  - zoom in/out
  - drag pan (touch)
  - pinch zoom best-effort
- Viewer must wrap canvas in a “page container” that later hosts overlay.

Acceptance:
- Upload, list, open plan; nav/zoom works on Android Chrome.

---

## Milestone 3 — Overlay + Add Issue mode + Pins + Issues CRUD (no photos)

DB: `issues` (sql/002_issues.sql):
- plan_id, issue_no, page, x_norm, y_norm, title, notes, category, status, priority, trade, assigned_to, due_date, timestamps
- unique(plan_id, issue_no)

API:
- GET list_issues?plan_id
- POST save_issue (create/update, JSON body)
  - create assigns next issue_no = max+1
  - validate 0..1 coords
- POST delete_issue

Frontend:
- Overlay layer aligned to PDF viewport
- Add Issue toggle: ON = tap to create pin draft
- Pins are HTML elements positioned from normalized coords
- Issue editor (drawer on tablet):
  - title required, notes, dropdowns
- Issue list panel + filters/search
- Tap issue: jump to page, center pin, highlight pulse

Acceptance:
- 3 issues saved; reload; pins don’t drift at zoom.

---

## Milestone 4 — Photos + Report export (online-first)

DB: `photos` (sql/003_photos.sql):
- id, plan_id, issue_id, file_path, thumb_path, created_at

Storage:
- `storage/photos/{plan_id}/{issue_id}/`

API:
- POST upload_photo (multipart: plan_id, issue_id, file)
  - validate image type/size
  - random filenames
  - create thumbnail via GD if available
- GET list_photos?issue_id
- POST delete_photo
- (optional) photo_file streaming by id
- POST/GET export_report.php?plan_id=... creates PDF report in storage/exports and returns URL

PDF report:
- A4 readable
- Uses thumbnails to keep size low
- Includes plan header + issue sections

Frontend:
- Client-side compression before upload (canvas resize + jpeg quality)
- Issue editor: thumbnails grid, view full, delete
- “Export report” button in plan view

Acceptance:
- Add photos, persist, delete; export report includes issues + thumbs.

---

## Milestone 5 — PWA + Offline-first + Sync queue + File Vault offline access

PWA:
- manifest.json (icons 192/512 + maskable)
- service-worker.js precache app shell
- runtime cache plan PDFs after first open

IndexedDB:
- plans, issues, photos_local (blobs), sync_queue, files, meta

Offline behavior:
- App loads offline
- Cached plan opens offline
- Create/edit issues offline (stored in IDB)
- Add photos offline (store blob in IDB, queue upload)
- Sync when online: push queued ops

File Vault:
DB: `files` (sql/004_files.sql)
API:
- upload_file, list_files, get_file, file_stream, delete_file
Frontend:
- Files screen with search/filter
- “Download for offline” -> store bytes in Cache Storage and set cached flag in IDB
- Open cached files offline

Acceptance:
- Airplane mode: app loads, cached plan opens, issue persists, offline photo queued; back online sync works.

---

## Milestone 6 — Advanced PDF Tools + Modern toolbar + Exports manager

Modern toolbar:
Plans | Merge | Split | Crop | Convert | Print | Batch Print | Exports | Help
- Mobile-first sticky header, hamburger menu, icons, 44px targets
- Shared `assets/ui.css` applied to all pages

Exports system:
DB: `exports` (sql/005_exports.sql)
API:
- list_exports
- delete_export
All tool outputs create exports records and save files under storage/exports.

Tools (server-side using FPDI/FPDF; gate optional features):
- Merge: merge PDFs (plans/files/exports or upload new)
- Split: extract range, optional split-to-pages ZIP
- Crop: CropBox approach preferred; fallback documented
- Convert:
  - PDF -> images ZIP (Imagick optional; if unavailable, disable with UI message)
  - images -> PDF (FPDF)
- Print: print-friendly view
- Batch print: generates merged batch_print.pdf export

Help page:
- Real usage + troubleshooting + diagnostics link

Acceptance:
- Each tool works end-to-end and outputs appear in Exports manager.

---

## Milestone 7 — Projects + Drawing Sets + Non-destructive Revisions (originals stay intact)

Concept:
- Originals (uploaded plans) are immutable.
- Users create “Revisions” that store overlays/issue state/tool ops as JSON.
- Exports are generated from a chosen revision without altering originals.

DB: (sql/007_projects_revisions.sql)
- projects
- project_plans (link plans to project with metadata)
- plan_revisions (state_json, based_on_revision_id)
- optionally add revision_id nullable to issues/photos (OR keep issues separate per revision)

API:
- create/list projects
- add plan to project + list project plans
- create/list/get revisions
- save_revision_state (state_json)
- export endpoints accept revision_id and render that revision

Frontend:
- Projects screen
- Drawing set view (filters by level/discipline/tag)
- Revision picker: Original (read-only) / Create Revision / Duplicate Revision
- Ensure “Next user starts clean” by defaulting to Original or a fresh revision.

Acceptance:
- Upload multiple drawings; create revision Day1 with markups; Day2 starts clean; exports reflect chosen revision.

---

# Quality + QA requirements (must do)

1) Create `docs/QA_REPORT.md`:
- For each milestone: PASS/PARTIAL/FAIL + evidence + gaps.

2) Create `docs/SMOKE_TESTS.md`:
- 10–15 minute manual tests with exact URLs and expected outcomes.

3) Logging:
- Use clean JSON error responses.
- Never echo PHP warnings in JSON (set error handling or ensure clean output).

4) Security:
- Validate IDs
- Validate uploads (type/size), block dangerous types
- Random filenames, no path traversal
- Prevent directory listing in storage

---

# Commit strategy (strict)
- Implement milestone-by-milestone.
- Small commits such as:
  - “Milestone 2: plans table + upload endpoint”
  - “Milestone 2: PDF.js viewer + mobile controls”
  - “Milestone 3: overlay coordinate mapping”
- After a milestone passes, update `docs/milestones.md` status row and add evidence paths/endpoints.

---

# Start now (first steps)
1) Implement Milestone 1 completely.
2) Then Milestone 2 completely.
Do not jump ahead.

End of prompt.
"""
