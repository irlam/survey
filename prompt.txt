# prompt.txt — survey.defecttracker.uk (Plesk shared hosting) — Fresh repo build (Composer + MySQL) — Mobile-first Survey PDF Editor

You are a coding agent working inside a NEW repository: https://github.com/irlam/survey
Deployment target: https://survey.defecttracker.uk/ on **Plesk shared hosting** (PHP 8.x), with a **MySQL/MariaDB** database.
Primary device: **Android tablet / mobile Chrome**. Desktop is secondary.

---

## Absolute hard rules (do not violate)
- **No Docker**. No container assumptions.
- **No Node build step** required to deploy. (Pure PHP + static assets)
- Use **Composer** for PHP dependencies and commit `composer.json` (do not commit secrets).
- Use **MySQL/MariaDB** with **PDO prepared statements**.
- All API endpoints return **JSON** and use proper **HTTP status codes**.
- Storage folders must be writable and **never committed** (keep `.gitkeep` only).
- Work in **small commits** with clear messages.
- After each milestone, update `docs/milestones.md` status table and add evidence links.
- Mobile UX: touch targets >= 44px; minimal typing; fast.

---

## Hosting specifics (Plesk shared hosting)
Design for:
- No root access assumptions.
- Composer might be available in Plesk (or via SSH). Provide fallback if not.
- Use `.htaccess` for:
  - disabling directory listing in /storage
  - basic security headers (safe defaults)
- Use server-side streaming endpoints for files so storage can be outside public web root if needed.

### Deployment model
Assume the repo contents are deployed at the site root:
- https://survey.defecttracker.uk/index.html
- https://survey.defecttracker.uk/api/...
If hosting uses a subfolder (e.g. /httpdocs), keep paths relative so it still works.

---

# 0) Repository structure (first commit)

Create this structure (no-build, mobile-first):

/api
  config.sample.php
  config-util.php
  db.php
  ping.php
  ...endpoints...
/app
  app.js
  router.js
  viewer.js
  overlay.js
  idb.js
  sync.js
  ui.js
/assets
  ui.css
  ui-icons.svg (optional)
/icons               (PWA icons incl 192/512 + maskable)
/sql
  001_init.sql
  002_issues.sql
  003_photos.sql
  004_files.sql
  005_exports.sql
  006_audit.sql
  007_projects_revisions.sql
/storage
  .gitkeep
  plans/.gitkeep
  photos/.gitkeep
  files/.gitkeep
  exports/.gitkeep
  tmp/.gitkeep
/docs
  milestones.md
  AGENT.md
  QA_REPORT.md       (generated)
  SMOKE_TESTS.md     (generated)
/tools
  merge.html
  split.html
  crop.html
  convert.html
  print.html
  batch-print.html
/help.html
/exports.html
/index.html
/manifest.json
/service-worker.js
/.gitignore
/README.md
/composer.json

### .gitignore
Exclude:
- /storage/** (keep .gitkeep)
- /api/config.php
- OS/editor junk

---

# 1) Composer (PHP dependencies)
Create composer.json (PHP 8.x compatible) with minimal libs:

Required:
- setasign/fpdf OR fpdf/fpdf (PDF generation)
- setasign/fpdi (import pages / merge / split)

Optional (feature-gated):
- ext-gd for thumbnails (recommended)
- ext-imagick for PDF->images conversion (optional; must gracefully disable if missing)

Notes:
- Prefer not committing /vendor.
- README must include two deployment methods:
  1) Run `composer install --no-dev` on server (Plesk/SSH)
  2) Run composer locally and upload /vendor (if server lacks composer)

---

# 2) Shared config + DB helper (foundation)
Create:

## api/config.sample.php
Include:
- base_url: "https://survey.defecttracker.uk" (or blank auto-detect)
- db_host, db_name, db_user, db_pass, db_charset
- storage_path (optional; default ../storage)
- max_upload_mb (e.g. 25)
- actor_name (for audit, optional)

## api/config-util.php
- load_config(): loads api/config.php if present
- base_url(): returns configured base_url or derives from request
- resolve_storage_path(): absolute path to storage
- ensure_dir($path): mkdir if missing, safe perms
- storage_dir($subpath): returns absolute path and ensures it exists

## api/db.php
- db(): PDO with ERRMODE_EXCEPTION and utf8mb4
- json_response($data, $status=200)
- error_response($msg, $status=400, $extra=[])
- require_method($method)
- read_json_body()
- safe_int($value)
- safe_string($value, $maxLen)

## api/ping.php
Return JSON:
- ok, timestamp, php_version
- storage writable flags
- db connectivity check (optional; do not leak credentials)

---

# 3) Docs baseline (must exist early)
Create README.md including:
- Requirements (PHP 8.x, PDO MySQL, ZipArchive, GD optional, Imagick optional)
- Setup (no docker):
  1) Create MySQL DB + user in Plesk
  2) Import sql files in order
  3) Copy api/config.sample.php → api/config.php (do not commit)
  4) composer install (server or local)
  5) Set storage folder permissions writable
- Troubleshooting:
  - upload_max_filesize, post_max_size, memory_limit
  - permissions (Plesk typical: 755 dirs, 644 files; storage writable by PHP)
- Endpoints list

Create docs/milestones.md + docs/AGENT.md (ensure they match this repo).

Agent must also create:
- docs/QA_REPORT.md
- docs/SMOKE_TESTS.md

---

# MILESTONES (implement in order, do not skip)

## Milestone 1 — Scaffold + storage + ping + config + init SQL + README
Deliver:
- structure + gitignore + storage layout
- config sample/util + db helper
- ping endpoint
- sql/001_init.sql with plans table (minimum)
- README setup

Acceptance:
- GET /api/ping.php returns ok:true and storage writable.

---

## Milestone 2 — Plans CRUD + Plan library + PDF.js viewer (mobile-first)
Backend:
- plans table in sql/001_init.sql
- storage/plans
- storage/.htaccess Options -Indexes
- API endpoints (JSON):
  - POST /api/upload_plan.php (multipart: file,name,revision)
  - GET /api/list_plans.php
  - GET /api/get_plan.php?plan_id=...
  - GET /api/plan_file.php?plan_id=... (stream PDF safely; Range support nice-to-have)

Frontend:
- Plans screen: list + upload
- Open plan: viewer with plan_id in query
- PDF.js viewer:
  - next/prev, page indicator
  - zoom buttons
  - pan/drag
  - pinch zoom best-effort
- Page container for future overlay.

Acceptance:
- Upload/list/open plan and navigate/zoom on Android.

---

## Milestone 3 — Overlay + Add Issue mode + Pins + Issues CRUD (no photos)
DB: issues table (sql/002_issues.sql) with normalized coords.
API:
- GET list_issues?plan_id
- POST save_issue (create/update JSON)
- POST delete_issue

Viewer:
- overlay div aligned to PDF viewport
- Add Issue toggle prevents accidental pin drops
- Pins placed and rendered using normalized coords (no drift)
UI:
- Issue drawer editor + issue list + filters/search + jump-to-pin

Acceptance:
- 3 issues saved; reload; zoom: pins remain aligned.

---

## Milestone 4 — Photos + Report export (online-first)
DB: photos table (sql/003_photos.sql)
API:
- upload_photo/list_photos/delete_photo
- export_report (PDF) using Composer libs
Frontend:
- client-side compression
- thumbnails grid and delete
- export report button

Acceptance:
- Photos persist; delete works; report includes issue data + thumbs.

---

## Milestone 5 — PWA + Offline-first + Sync queue + File Vault offline access
PWA:
- manifest.json + service-worker.js + icons
- cache app shell and PDF.js assets
Offline:
- IndexedDB stores + sync queue for issues and photos
File Vault:
- files table + endpoints
- “download for offline” stores bytes in Cache Storage and metadata in IDB

Acceptance:
- Install PWA, open cached plan offline, add issue offline, sync when online.

---

## Milestone 6 — Advanced PDF Tools + Modern toolbar + Exports manager
- Modern toolbar (mobile-first sticky header + hamburger)
- Exports table + Exports Manager page
- Tools:
  - merge/split/crop/convert/print/batch-print
- Every output saved to storage/exports and recorded in exports table
- Optional: port patterns/tools from https://github.com/irlam/pdf, adapting to this repo’s config/storage.

Acceptance:
- Each tool produces a downloadable export listed in Exports Manager.

---

## Milestone 7 — Projects + Drawing Sets + Non-destructive Revisions
- Projects (drawing sets) with metadata and ordering
- Revisions store state_json so originals remain intact for the next user
- Exports can be generated from a chosen revision

Acceptance:
- Multiple drawings in a project, Day1 revision has markups, Day2 starts clean, exports reflect selected revision.

---

# Security + performance requirements (apply throughout)
- Validate IDs and inputs
- Validate uploads: type/size; random filenames; prevent traversal
- Never return absolute filesystem paths in JSON
- Use streaming endpoints for file access (PDF/image/file vault) to keep storage safer
- Add a tmp cleanup routine (on demand or documented cron)

---

# Commit strategy (strict)
Small commits like:
- “Milestone 1: config util + db helper + ping”
- “Milestone 2: plans upload/list/get”
- “Milestone 2: PDF.js viewer mobile controls”
- “Milestone 3: overlay coordinate mapping”
After each milestone passes, update docs/milestones.md status row with date + evidence.

---

# Start now
1) Implement Milestone 1 fully.
2) Then Milestone 2 fully.
Do not jump ahead.

End of prompt.
