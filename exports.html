<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Exports Manager</title>
  <link rel="stylesheet" href="/assets/ui.css?v=20260124_1">
</head>
<body>
  <header class="toolbar">
    <button id="menuBtn">☰</button>
    <h1>Exports Manager</h1>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
      <button id="scanBtn" class="btn">Scan & Import</button>
    </div>
  </header>
  <main>
    <ul id="exportsList"></ul>
  </main>
  <script>
    async function deleteExport(id) {
      if (!confirm('Delete this export file? This will remove the file and the DB record.')) return;
      const res = await fetch('/api/delete_export.php', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ id }) });
      if (!res.ok) { alert('Delete failed'); return; }
      const data = await res.json();
      if (!data.ok) { alert('Delete failed: ' + (data.error||'unknown')); return; }
      loadExports();
    }

    async function scanImports() {
      if (!confirm('Scan storage/exports and import missing files into the DB?')) return;
      const btn = document.getElementById('scanBtn'); btn.disabled = true; btn.textContent = 'Scanning...';
      const res = await fetch('/api/import_exports.php', { method: 'POST', headers:{'Content-Type':'application/json'} });
      const j = await res.json();
      btn.disabled = false; btn.textContent = 'Scan & Import';
      if (j && j.count) alert('Imported ' + j.count + ' file(s)');
      await loadExports();
    }

    async function loadExports() {
      const ul = document.getElementById('exportsList');
      ul.innerHTML = '<li>Loading...</li>';
      const res = await fetch('/api/list_exports.php');
      if (!res.ok) { ul.innerHTML = '<li>Failed to load</li>'; return; }
      const data = await res.json();
      ul.innerHTML = '';
      if (!data.exports || data.exports.length === 0) {
        ul.innerHTML = '<li>No exports found — try "Scan & Import" to import files found on disk.</li>';
        return;
      }
      for (const exp of data.exports) {
        const li = document.createElement('li');
        li.innerHTML = `<a href="/storage/exports/${exp.filename}" target="_blank">${exp.filename}</a> <span>${exp.type}</span> <span>${exp.created_at}</span> <button data-id="${exp.id}" class="delBtn">Delete</button>`;
        li.style.minHeight = '44px';
        ul.appendChild(li);
      }
      Array.from(document.querySelectorAll('.delBtn')).forEach(b=> b.onclick = (e)=>{ const id = Number(e.target.dataset.id); deleteExport(id); });
    }
    loadExports();
    document.getElementById('menuBtn').onclick = () => {
      alert('Menu coming soon');
    };
  </script>
</body>
</html>
