<!DOCTYPE html>
<!-- exports.html - Exports manager (04/02/2026) -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Exports Manager</title>
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="/assets/ui.css?v=20260204_1">
</head>
<body>
  <header class="toolbar">
    <button id="menuBtn" aria-label="Open menu" aria-expanded="false">☰</button>
    <h1>Exports Manager</h1>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
      <span id="selectedCount" class="muted" aria-live="polite">0 selected</span>
      <label class="tool-card" style="display:flex;align-items:center;gap:6px;padding:6px 10px;">
        <input id="selectAllExports" type="checkbox" aria-label="Select all exports">
        <span>Select all</span>
      </label>
      <button id="deleteSelectedBtn" class="btn btnDanger" disabled>Delete selected</button>
      <button id="scanBtn" class="btn">Scan & Import</button>
    </div>
  </header>

  <!-- off-canvas menu -->
  <div id="menuBackdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:99998;"></div>
  <nav id="offcanvasMenu" role="navigation" aria-label="Site" aria-hidden="true" style="position:fixed;left:-280px;top:0;bottom:0;width:260px;background:rgba(2,6,10,.95);padding:18px;z-index:99999;box-shadow: 6px 0 30px rgba(0,0,0,.6);transition:left .22s ease;">
    <button id="menuClose" class="iconBtn" style="margin-bottom:12px" aria-label="Close menu">×</button>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px;">
      <a class="tool-card" href="/" style="background:none;box-shadow:none;border:none;padding:8px;color:var(--text);text-decoration:none">Home</a>
      <a class="tool-card" href="/tools/index.html" style="background:none;box-shadow:none;border:none;padding:8px;color:var(--text);text-decoration:none">Tools</a>
      <a class="tool-card" href="/exports.html" style="background:none;box-shadow:none;border:none;padding:8px;color:var(--text);text-decoration:none">Exports</a>
      <a class="tool-card" href="/tools/issues.html" style="background:none;box-shadow:none;border:none;padding:8px;color:var(--text);text-decoration:none">Issue Manager</a>
    </div>
  </nav>
  <main>
    <div style="padding:12px;">
      <div id="exportsGrid" class="export-grid" aria-busy="false" role="list">Loading…</div>
    </div>
  </main>
  <style>
    /* Local styles to make the exports list pop on mobile */
    .export-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:12px; }
    .export-card{ border-radius:12px; padding:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); border:1px solid rgba(0,255,231,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.6); display:flex; gap:12px; align-items:center; justify-content:space-between; transition: transform .12s ease, box-shadow .12s ease; }
    .export-card:hover{ transform: translateY(-6px); box-shadow: 0 18px 44px rgba(0,255,231,0.12); }
    .offcanvas-open #menuBackdrop{ opacity:1; pointer-events:auto; }
    .export-meta{ min-width:0; overflow:hidden; flex:1 }
    .export-name{ font-weight:900; color:var(--neon); font-size:0.95rem; white-space:normal; word-break:break-word }
    .export-sub{ color:var(--muted); font-size:12px; margin-top:6px }
    .export-actions{ display:flex; gap:8px; align-items:center; flex-shrink:0 }
    .iconBtnSmall{ min-width:36px; min-height:36px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.36); color:var(--neon); box-shadow: none; cursor:pointer }
    .btnDanger{ background: linear-gradient(90deg, #ff6b6b, #ff3b3b); color:#041013; border:none; padding:8px 12px; border-radius:10px; font-weight:800 }
    .export-check{ width:18px; height:18px; accent-color:#ff6b6b; cursor:pointer }
    @media (max-width:520px){ .export-grid{ grid-template-columns: 1fr; } .export-card{ padding:14px } .export-name{ font-size:1rem } }
  </style>

  <script>
    /* Off-canvas menu handling */
    const off = document.getElementById('offcanvasMenu');
    const backdrop = document.getElementById('menuBackdrop');
    const menuBtn = document.getElementById('menuBtn');
    function setMenu(open){
      document.body.classList.toggle('offcanvas-open', open);
      off.style.left = open ? '0' : '-280px';
      off.setAttribute('aria-hidden', open ? 'false' : 'true');
      if (menuBtn) menuBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
    }
    if (menuBtn) menuBtn.onclick = ()=> setMenu(true);
    document.getElementById('menuClose').onclick = ()=> setMenu(false);
    if (backdrop) backdrop.onclick = ()=> setMenu(false);
    document.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape') setMenu(false); });

    /* Snackbar / Undo helper */
    function showUndoSnack(message, undoLabel, undoCb) {
      let sb = document.getElementById('snackbar');
      if (!sb) {
        sb = document.createElement('div'); sb.id = 'snackbar'; sb.setAttribute('role','status'); sb.setAttribute('aria-live','polite');
        sb.style.position = 'fixed'; sb.style.left = '50%'; sb.style.transform = 'translateX(-50%)'; sb.style.bottom = '20px'; sb.style.zIndex = 99999;
        sb.style.background = 'linear-gradient(90deg, rgba(6,56,56,0.95), rgba(0,255,160,0.06))'; sb.style.color='#fff'; sb.style.padding='12px 16px'; sb.style.borderRadius='10px'; sb.style.boxShadow='0 12px 30px rgba(0,0,0,.5)'; sb.style.display='flex'; sb.style.gap='12px'; sb.style.alignItems='center';
        document.body.appendChild(sb);
      }
      sb.innerHTML = '';
      const txt = document.createElement('div'); txt.textContent = message; sb.appendChild(txt);
      if (undoCb) {
        const undo = document.createElement('button'); undo.className = 'btnPrimary'; undo.textContent = undoLabel||'Undo'; undo.onclick = async ()=>{ try{ await undoCb(); }catch(e){ alert('Undo failed'); } sb.style.display='none'; };
        sb.appendChild(undo);
      }
      sb.style.display = 'flex';
      clearTimeout(sb._timeout);
      sb._timeout = setTimeout(()=>{ sb.style.display='none'; }, 8000);
    }

    function formatDate(ts){ if(!ts) return ''; try{ const d = new Date(ts); return d.toLocaleString('en-GB', { hour12: false }); }catch(e){ return ts; } }

    const selectedExportIds = new Set();

    function updateBulkControls(totalExports = 0) {
      const selectAll = document.getElementById('selectAllExports');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const selectedLabel = document.getElementById('selectedCount');
      const selectedCount = selectedExportIds.size;
      deleteBtn.disabled = selectedCount === 0;
      if (selectedLabel) selectedLabel.textContent = selectedCount + ' selected';
      if (totalExports === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        return;
      }
      if (selectedCount === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (selectedCount === totalExports) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    async function deleteExport(id) {
      if (!confirm('Delete this export file? This will move it to trash and remove the DB record.')) return;
      try{
        const res = await fetch('/api/delete_export.php', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ id }) });
        const data = await res.json();
        if (!res.ok || !data.ok) { alert('Delete failed: ' + (data.error||'unknown')); return; }
        showUndoSnack('Export deleted', 'Undo', async ()=>{
          // call restore_trash with returned trash path
          const trash = data.trash; if(!trash) throw new Error('No trash info');
          const r = await fetch('/api/restore_trash.php',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ trash }) });
          const jr = await r.json(); if(!r.ok || !jr.ok) throw new Error(jr.error||'restore failed');
          await loadExports();
        });
        await loadExports();
      }catch(e){ alert('Delete failed: '+e.message); }
    }

    async function deleteSelectedExports() {
      if (selectedExportIds.size === 0) return;
      if (!confirm(`Delete ${selectedExportIds.size} export file(s)? This will move them to trash and remove the DB records.`)) return;
      const ids = Array.from(selectedExportIds);
      const failures = [];
      for (const id of ids) {
        try{
          const res = await fetch('/api/delete_export.php', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ id }) });
          const data = await res.json();
          if (!res.ok || !data.ok) failures.push(id);
        }catch(e){ failures.push(id); }
      }
      if (failures.length) {
        alert(`Failed to delete ${failures.length} export(s).`);
      } else {
        showUndoSnack(`Deleted ${ids.length} export(s)`);
      }
      selectedExportIds.clear();
      await loadExports();
    }

    async function scanImports() {
      if (!confirm('Scan storage/exports and import missing files into the DB?')) return;
      const btn = document.getElementById('scanBtn'); btn.disabled = true; btn.textContent = 'Scanning...';
      try{
        const res = await fetch('/api/import_exports.php', { method: 'POST', headers:{'Content-Type':'application/json'} });
        const j = await res.json();
        if (j && j.count) showUndoSnack('Imported ' + j.count + ' file(s)');
      }catch(e){ showUndoSnack('Scan failed'); }
      btn.disabled = false; btn.textContent = 'Scan & Import';
      await loadExports();
    }

    async function loadExports() {
      const wrap = document.getElementById('exportsGrid');
      wrap.setAttribute('aria-busy','true');
      wrap.innerHTML = '<div class="card">Loading…</div>';
      try{
        const res = await fetch('/api/list_exports.php');
        if (!res.ok) { wrap.innerHTML = '<div class="card">Failed to load</div>'; wrap.setAttribute('aria-busy','false'); return; }
        const data = await res.json();
        if (!data.exports || data.exports.length === 0) {
          wrap.innerHTML = '<div class="card"><div style="display:flex;flex-direction:column;gap:6px"><div style="font-weight:800">No exports found</div><div style="color:var(--muted)">Try "Scan & Import" to add files found on disk.</div></div></div>';
          wrap.setAttribute('aria-busy','false');
          return;
        }
        wrap.innerHTML = '';
        const exportIds = new Set();
        for (const exp of data.exports) {
          exportIds.add(Number(exp.id));
          const card = document.createElement('div'); card.className = 'export-card card'; card.dataset.exportId = exp.id; card.setAttribute('role','listitem');
          const meta = document.createElement('div'); meta.className = 'export-meta';
          const name = document.createElement('div'); name.className = 'export-name'; name.textContent = exp.filename;
          const sub = document.createElement('div'); sub.className = 'export-sub'; sub.textContent = (exp.type ? exp.type.toUpperCase() + ' • ' : '') + formatDate(exp.created_at);
          meta.appendChild(name); meta.appendChild(sub);
          const actions = document.createElement('div'); actions.className = 'export-actions';

          const checkWrap = document.createElement('label');
          checkWrap.style.display = 'flex';
          checkWrap.style.alignItems = 'center';
          checkWrap.style.gap = '6px';
          const check = document.createElement('input');
          check.type = 'checkbox';
          check.className = 'export-check';
          check.checked = selectedExportIds.has(Number(exp.id));
          check.setAttribute('aria-label', `Select export ${exp.filename}`);
          check.addEventListener('change', () => {
            if (check.checked) {
              selectedExportIds.add(Number(exp.id));
            } else {
              selectedExportIds.delete(Number(exp.id));
            }
            updateBulkControls(exportIds.size);
          });
          checkWrap.appendChild(check);
          actions.appendChild(checkWrap);

          const linkBtn = document.createElement('a'); linkBtn.className = 'iconBtnSmall'; linkBtn.href = '/storage/exports/' + encodeURIComponent(exp.filename);
          linkBtn.title = 'Open file'; linkBtn.setAttribute('aria-label', 'Open export ' + exp.filename); linkBtn.target = '_blank'; linkBtn.rel = 'noopener'; linkBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 3h7v7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 14L21 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';

          const dl = document.createElement('a'); dl.className = 'iconBtnSmall'; dl.href = '/storage/exports/' + encodeURIComponent(exp.filename); dl.download = exp.filename; dl.title = 'Download'; dl.setAttribute('aria-label', 'Download export ' + exp.filename); dl.rel = 'noopener'; dl.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';

          const del = document.createElement('button'); del.className = 'btnDanger'; del.textContent = 'Delete'; del.onclick = ()=> deleteExport(Number(exp.id));
          actions.appendChild(linkBtn); actions.appendChild(dl); actions.appendChild(del);

          card.appendChild(meta); card.appendChild(actions);
          wrap.appendChild(card);
        }
        for (const id of Array.from(selectedExportIds)) {
          if (!exportIds.has(id)) selectedExportIds.delete(id);
        }
        updateBulkControls(exportIds.size);
        wrap.setAttribute('aria-busy','false');
      }catch(e){ wrap.innerHTML = '<div class="card">Load error</div>'; wrap.setAttribute('aria-busy','false'); }
    }

    loadExports();
    document.getElementById('selectAllExports').addEventListener('change', (event) => {
      const checks = document.querySelectorAll('.export-check');
      if (!checks.length) return;
      if (event.target.checked) {
        selectedExportIds.clear();
        checks.forEach((check) => {
          check.checked = true;
          const card = check.closest('.export-card');
          if (card && card.dataset.exportId) {
            selectedExportIds.add(Number(card.dataset.exportId));
          }
        });
      } else {
        checks.forEach((check) => { check.checked = false; });
        selectedExportIds.clear();
      }
      const total = checks.length;
      updateBulkControls(total);
    });
    document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedExports);
    off.querySelectorAll('a').forEach((link)=> link.addEventListener('click', ()=> setMenu(false)));
  </script>
</body>
</html>
