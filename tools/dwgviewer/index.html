<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CAD Simple Viewer Example</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f5f5f5;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .file-input-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        pointer-events: none;
        transition: all 0.3s ease;
      }
      
      .file-input-container.loaded {
        top: 2rem;
        left: 2rem;
        transform: none;
      }
      
      .file-fab {
        pointer-events: auto;
        background: #23272f;
        color: #e0e0e0;
        border: none;
        border-radius: 12px;
        width: 80px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
        padding: 0;
        position: relative;
      }
      
      .file-input-container.loaded .file-fab {
        width: 40px;
        height: 32px;
      }
      
      .file-fab:hover {
        background: #353b45;
        box-shadow: 0 4px 16px rgba(0,0,0,0.22);
      }
      .file-fab input[type="file"] {
        /* keep input accessible but visually hidden and covering the button so clicks open file picker reliably */
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }
      .file-fab-label {
        margin-top: 0.5rem;
        color: #fff;
        font-size: 1.2rem;
        text-align: center;
        text-shadow: 0 1px 4px rgba(0,0,0,0.18);
        transition: all 0.3s ease;
      }
      
      .file-input-container.loaded .file-fab-label {
        font-size: 1rem;
      }
      
      .file-icon {
        transition: all 0.3s ease;
      }
      
      .file-input-container.loaded .file-icon {
        width: 20px;
        height: 20px;
      }
      
      .file-fab svg {
        display: block;
        margin: 0 auto;
      }
      
      .button-group {
        display: flex;
        gap: 1.5rem;
        align-items: center;
      }
      
      .file-input-container.loaded .button-group {
        gap: 1rem;
      }
      
      .button-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      .file-input-container.hide {
        display: none;
      }

      .viewer-container {
        flex: 1;
        position: relative;
        background: #2c2c2c;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        touch-action: none;
      }

      #cad-container {
        width: 100%;
        height: 100%;
        display: block;
        touch-action: none;
        cursor: grab;
      }
      #cad-container.drag-pan {
        cursor: grabbing;
      }

      .dwg-toolbar {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        max-width: calc(100vw - 160px);
        background: rgba(18, 22, 28, 0.92);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 8px 10px;
        color: #e0e0e0;
        box-shadow: 0 10px 28px rgba(0,0,0,0.28);
      }
      .dwg-toolbar .group {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        padding-right: 8px;
        border-right: 1px solid rgba(255,255,255,0.06);
      }
      .dwg-toolbar .group:last-child {
        border-right: none;
        padding-right: 0;
      }
      .dwg-toolbar button {
        border: none;
        background: #2a3240;
        color: #e0e0e0;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
      }
      .dwg-toolbar button.toggle.on {
        background: #00b3ff;
        color: #041013;
        font-weight: 700;
      }
      .dwg-toolbar button:hover {
        background: #3a4558;
      }
      .dwg-toolbar .hint {
        font-size: 12px;
        color: #b8c2d1;
        margin-left: 6px;
        white-space: nowrap;
      }
      .pan-hint {
        position: absolute;
        right: 16px;
        bottom: 16px;
        z-index: 1000;
        background: rgba(18, 22, 28, 0.92);
        color: #e0e0e0;
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px;
        padding: 8px 12px;
        font-size: 12px;
        letter-spacing: 0.2px;
        box-shadow: 0 10px 28px rgba(0,0,0,0.28);
        opacity: 0;
        transform: translateY(6px);
        transition: opacity 0.25s ease, transform 0.25s ease;
        pointer-events: none;
      }
      .pan-hint.show {
        opacity: 1;
        transform: translateY(0);
      }
      @media (max-width: 720px){
        .dwg-toolbar {
          left: 10px;
          right: 10px;
          max-width: none;
        }
        .dwg-toolbar .hint {
          display: none;
        }
      }
    </style>
    <script>
      // Dynamic module loader: try a fixed local copy first, then fallback to the original bundle.
      // Import a dedicated loader module which handles robust import/repair
      document.addEventListener('DOMContentLoaded', async () => {
        try{
          await import('./dwgviewer-loader.js?t=' + Date.now());
          console.log('dwgviewer-loader imported successfully');

          // Auto-init helper: poll for viewer readiness and try safe initialization heuristics
          (function autoInitViewer(){
            console.log('Auto-init: starting poll for AcApDocManager.instance');
            let attempts = 0;
            const maxAttempts = 60; // ~30s at 500ms interval
            const intervalMs = 500;
            const timer = setInterval(() => {
              attempts++;
              try {
                if (window.AcApDocManager && window.AcApDocManager.instance) {
                  console.log('Auto-init: AcApDocManager.instance is ready (after', attempts, 'attempts)');
                  clearInterval(timer);
                  return;
                }

                // 1) If the repaired bundle exposes a createInstance helper on __dwg_bundle, try that first
                try {
                  const b = window.__dwg_bundle;
                  if (b && typeof b.createInstance === 'function') {
                    console.log('Auto-init: calling __dwg_bundle.createInstance()');
                    try {
                      b.createInstance({ container: document.getElementById('cad-container'), autoResize: true, baseUrl: b.baseUrl || undefined });
                    } catch (e) {
                      console.warn('Auto-init: __dwg_bundle.createInstance threw', e);
                    }
                  }
                } catch (e) { /* ignore */ }

                // 2) Heuristic: look for global constructors whose source contains viewer initialization clues and try to instantiate them
                try {
                  const candidates = [];
                  for (const k of Object.getOwnPropertyNames(window)) {
                    try {
                      const v = window[k];
                      if (typeof v === 'function') {
                        const s = v.toString();
                        if (s && (s.includes('this.container=document.getElementById("cad-container")') || s.includes('initialize(){if(!this.isInitialized)') || s.includes('Failed to initialize CAD viewer'))) {
                          candidates.push(k);
                        }
                      }
                    } catch (e) {}
                  }
                  if (candidates.length) console.log('Auto-init: constructor candidates', candidates.slice(0,10));
                  for (const name of candidates) {
                    try {
                      const C = window[name];
                      const inst = new C();
                      console.log('Auto-init: new ' + name + '() succeeded, instance:', inst);
                      clearInterval(timer);
                      return;
                    } catch (e) {
                      console.warn('Auto-init: new failed for', name, e);
                    }
                  }
                } catch (e) { /* ignore */ }

                if (attempts >= maxAttempts) {
                  console.log('Auto-init: giving up after', attempts, 'attempts');
                  clearInterval(timer);
                }
              } catch (e) {
                console.warn('Auto-init: poll error', e);
              }
            }, intervalMs);
          })();

        }catch(err){
          console.error('Failed to import dwgviewer-loader.js', err);
          alert('DWG viewer failed to initialize (see console).');
        }
      });

      function getViewerInstance(){
        try{
          if (window.__dwg_docmgr && window.__dwg_docmgr.instance) return window.__dwg_docmgr.instance;
          if (window.AcApDocManager && window.AcApDocManager.instance) return window.AcApDocManager.instance;
          if (window.__dwg_docmgr && typeof window.__dwg_docmgr.createInstance === 'function') {
            window.__dwg_docmgr.createInstance({ container: document.getElementById('cad-container'), autoResize: true, baseUrl: 'https://cdn.jsdelivr.net/gh/mlightcad/cad-data@main/' });
            return window.__dwg_docmgr.instance || null;
          }
          if (window.AcApDocManager && typeof window.AcApDocManager.createInstance === 'function') {
            window.AcApDocManager.createInstance({ container: document.getElementById('cad-container'), autoResize: true, baseUrl: 'https://cdn.jsdelivr.net/gh/mlightcad/cad-data@main/' });
            return window.AcApDocManager.instance || null;
          }
          if (window.__dwg_bundle && window.__dwg_bundle.instance) return window.__dwg_bundle.instance;
        }catch(e){ console.warn('getViewerInstance failed', e); }
        return null;
      }
      function ensureViewerInstance(){
        return !!getViewerInstance();
      }
      function enableLeftDragPan(){
        try{
          const instance = getViewerInstance();
          if (!instance) return false;
          const view = instance.curView || (instance.context && instance.context.view) || (instance._context && instance._context.view);
          const controls = view && (view.cameraControls || view._cameraControls || view.controls);
          if (!controls || !controls.mouseButtons) return false;
          const mb = controls.mouseButtons;
          const middle = mb.MIDDLE ?? mb.MIDDLE_BUTTON ?? mb.PAN ?? null;
          if (middle == null) return false;
          if (mb.LEFT !== middle) {
            mb.LEFT = middle;
            if (typeof controls.update === 'function') controls.update();
          }
          if (controls.touches && controls.touches.ONE == null && controls.touches.TWO != null) {
            controls.touches.ONE = controls.touches.TWO;
          }
          return true;
        }catch(e){
          console.warn('enableLeftDragPan failed', e);
        }
        return false;
      }
      function wirePanCursor(){
        try{
          const container = document.getElementById('cad-container');
          if (!container || container.dataset.panCursor === '1') return;
          container.dataset.panCursor = '1';
          const set = (on)=>{ if(on) container.classList.add('drag-pan'); else container.classList.remove('drag-pan'); };
          container.addEventListener('pointerdown', (e)=>{ if (e.button === 0) set(true); });
          window.addEventListener('pointerup', ()=> set(false));
          window.addEventListener('pointercancel', ()=> set(false));
        }catch(e){}
      }
      function showPanHint(){
        try{
          const hint = document.getElementById('panHint');
          if (!hint || hint.dataset.shown === '1') return;
          hint.dataset.shown = '1';
          hint.classList.add('show');
          window.setTimeout(()=> hint.classList.remove('show'), 4200);
        }catch(e){}
      }
      function activateCadInteraction(){
        try{
          const container = document.getElementById('cad-container');
          if (container){
            container.setAttribute('tabindex','0');
            container.style.touchAction = 'none';
            container.style.userSelect = 'none';
            container.style.pointerEvents = 'auto';
            container.focus({ preventScroll: true });
            const canv = container.querySelector('canvas');
            if (canv){
              canv.style.touchAction = 'none';
              canv.style.pointerEvents = 'auto';
            }
          }
          document.body.style.overscrollBehavior = 'none';
          enableLeftDragPan();
          wirePanCursor();
          showPanHint();
        }catch(e){}
        // Default to pan so drag works immediately
        try{
          const instance = getViewerInstance();
          if (instance && typeof instance.sendStringToExecute === 'function') {
            instance.sendStringToExecute('pan');
          }
        }catch(e){}
      }
      // Message listener for loading files from other windows
      window.addEventListener('message', async (event) => {
        if (event.origin !== window.location.origin) return; // Security check
        if (event.data && event.data.type === 'loadFile') {
          const { file, filename } = event.data;
          try {
            const instance = getViewerInstance();
            if (!instance) throw new Error('Viewer not initialized');
            if (typeof instance.openDocument !== 'function') throw new Error('Viewer not initialized');
            await instance.openDocument(filename, file, { minimumChunkSize: 1000, readOnly: true, mouseControls: true });
            activateCadInteraction();
            // Hide UI after successful load
            const fileInputContainer = document.getElementById('fileInputContainer');
            if (fileInputContainer) {
              fileInputContainer.classList.add('loaded');
            }
            // Hide new drawing button
            const newDrawingButton = document.getElementById('newDrawingButton');
            if (newDrawingButton) {
              newDrawingButton.style.display = 'none';
            }
            const newButtonLabel = newDrawingButton?.parentElement?.querySelector('.file-fab-label');
            if (newButtonLabel) {
              newButtonLabel.style.display = 'none';
            }
          } catch (err) {
            console.error('Load file failed', err);
            alert('Load file failed: ' + (err && err.message ? err.message : err));
          }
        }
      });
    </script>
  </head>
  <body>
    <div style="position: absolute; top: 10px; left: 10px; z-index: 1000;">
      <button onclick="window.location.href='/'" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Back to Home</button>
    </div>
    <div class="dwg-toolbar">
      <div class="group">
        <button id="dwgPanBtn" title="Pan (drag the view)">Pan</button>
        <button id="dwgZoomBtn" title="Zoom (scroll to zoom)">Zoom</button>
        <button id="dwgZoomFitBtn" title="Zoom to fit">Fit</button>
        <button id="dwgRegenBtn" title="Regenerate view">Regen</button>
      </div>
      <div class="group">
        <button id="dwgGridBtn" class="toggle" title="Toggle grid">Grid</button>
        <button id="dwgSnapBtn" class="toggle" title="Toggle snap">Snap</button>
        <button id="dwgOsnapBtn" class="toggle" title="Toggle object snap">Osnap</button>
      </div>
      <div class="group">
        <button id="dwgLayersBtn" title="List layers">Layers</button>
        <button id="dwgInfoBtn" title="Show file info">Info</button>
      </div>
      <div class="group">
        <button id="dwgSelectBtn" title="Select entities">Select</button>
        <button id="dwgLineBtn" title="Draw line">Line</button>
        <button id="dwgCircleBtn" title="Draw circle">Circle</button>
        <button id="dwgResetBtn" title="Reset view">Reset</button>
      </div>
      <span class="hint">Command box accepts CAD commands (e.g. pan, zoom, line)</span>
    </div>
    <div class="viewer-container">
      <div class="file-input-container" id="fileInputContainer">
        <div class="button-group">
          <div class="button-container">
            <label class="file-fab" id="fileFab">
              <input type="file" id="fileInputElement" accept=".dxf,.dwg" />
              <svg width="40" height="40" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="file-icon">
                <path d="M3 6.5V15a1.5 1.5 0 0 0 1.5 1.5h11A1.5 1.5 0 0 0 17 15V7.5A1.5 1.5 0 0 0 15.5 6H7.414a1.5 1.5 0 0 1-1.06-.44l-1.414-1.414A1.5 1.5 0 0 0 4.586 4H4.5A1.5 1.5 0 0 0 3 5.5V6.5z"/>
                <path d="M8 11v2m0 0v-2m0 2h4m-4 0h4"/>
              </svg>
            </label>
            <div class="file-fab-label">Open</div>
          </div>
          <div class="button-container">
            <button class="file-fab" id="newDrawingButton">
              <svg width="40" height="40" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="file-icon">
                <path d="M10 3v14M3 10h14"/>
              </svg>
            </button>
            <div class="file-fab-label">New</div>
          </div>

          <div class="button-container">
            <button class="file-fab" id="loadSampleBtn" title="Load sample DWG">
              <svg width="40" height="40" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="file-icon">
                <path d="M4 7h12M4 11h8M4 15h8" />
              </svg>
            </button>
            <div class="file-fab-label">Sample</div>
          </div>

          <div class="button-container">
            <button class="file-fab" id="initViewerBtn" title="Init viewer (debug)">
              <svg width="40" height="40" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="file-icon">
                <path d="M3 6h14M3 10h14M3 14h14" />
              </svg>
            </button>
            <div class="file-fab-label">Init</div>
          </div>

          <div class="button-container">
            <button class="file-fab" id="exportPdfBtn" title="Export to PDF">
              <svg width="40" height="40" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="file-icon">
                <path d="M12 10v6m0 0l-3-3m3 3l3-3" />
              </svg>
            </button>
            <div class="file-fab-label">PDF</div>
          </div>
        </div>
      </div>
      <div id="cad-container"></div>
      <div class="pan-hint" id="panHint">Drag to pan â€¢ Scroll to zoom</div>
    </div>

    <script>
      // Ensure the file fab forwards clicks to the hidden file input (defensive)
      document.addEventListener('DOMContentLoaded', ()=>{
        // Removed redundant click handler to prevent double file dialog
        const runCmd = (cmd) => {
          try{
            const instance = getViewerInstance();
            if (instance && typeof instance.sendStringToExecute === 'function') {
              instance.sendStringToExecute(cmd);
              return true;
            }
          }catch(e){ console.warn('Command failed', e); }
          return false;
        };
        const toggleBtn = (btn) => {
          if (!btn) return;
          btn.classList.toggle('on');
        };
        const panBtn = document.getElementById('dwgPanBtn');
        if (panBtn) panBtn.addEventListener('click', () => runCmd('pan'));
        const zoomBtn = document.getElementById('dwgZoomBtn');
        if (zoomBtn) zoomBtn.addEventListener('click', () => runCmd('zoom'));
        const zoomFitBtn = document.getElementById('dwgZoomFitBtn');
        if (zoomFitBtn) zoomFitBtn.addEventListener('click', () => runCmd('zoom'));
        const regenBtn = document.getElementById('dwgRegenBtn');
        if (regenBtn) regenBtn.addEventListener('click', () => runCmd('regen'));
        const gridBtn = document.getElementById('dwgGridBtn');
        if (gridBtn) gridBtn.addEventListener('click', () => { if (runCmd('grid')) toggleBtn(gridBtn); });
        const snapBtn = document.getElementById('dwgSnapBtn');
        if (snapBtn) snapBtn.addEventListener('click', () => { if (runCmd('snap')) toggleBtn(snapBtn); });
        const osnapBtn = document.getElementById('dwgOsnapBtn');
        if (osnapBtn) osnapBtn.addEventListener('click', () => { if (runCmd('osnap')) toggleBtn(osnapBtn); });
        const layersBtn = document.getElementById('dwgLayersBtn');
        if (layersBtn) layersBtn.addEventListener('click', () => runCmd('layer'));
        const infoBtn = document.getElementById('dwgInfoBtn');
        if (infoBtn) infoBtn.addEventListener('click', () => runCmd('log'));
        const selectBtn = document.getElementById('dwgSelectBtn');
        if (selectBtn) selectBtn.addEventListener('click', () => runCmd('select'));
        const lineBtn = document.getElementById('dwgLineBtn');
        if (lineBtn) lineBtn.addEventListener('click', () => runCmd('line'));
        const circleBtn = document.getElementById('dwgCircleBtn');
        if (circleBtn) circleBtn.addEventListener('click', () => runCmd('circle'));
        const resetBtn = document.getElementById('dwgResetBtn');
        if (resetBtn) resetBtn.addEventListener('click', () => runCmd('zoom'));

        // Sample loader button (convenience for debugging / testing)
        const loadSampleBtn = document.getElementById('loadSampleBtn');
        if(loadSampleBtn){
          const findLabel = ()=>{
            // label sits adjacent to the button in markup
            const parent = loadSampleBtn.parentElement;
            if(!parent) return null;
            return parent.querySelector('.file-fab-label');
          };

          loadSampleBtn.addEventListener('click', async (e)=>{
            const label = findLabel();
            const prevLabel = label && label.textContent;
            loadSampleBtn.disabled = true;
            if(label) label.textContent = 'Loading...';
            try{
              // Load sample DWG from CDN
              const response = await fetch('https://cdn.jsdelivr.net/gh/mlightcad/cad-data@main/samples/arc_2000.dwg');
              if (!response.ok) throw new Error('Failed to fetch sample');
              const arrayBuffer = await response.arrayBuffer();
              // Use AcApDocManager like in loadFile
              const instance = getViewerInstance();
              if (!instance || typeof instance.openDocument !== 'function') throw new Error('Viewer not initialized');
              await instance.openDocument('arc_2000.dwg', arrayBuffer, { minimumChunkSize: 1000, readOnly: true, mouseControls: true });
              activateCadInteraction();
              // Hide UI after successful load
              const fileInputContainer = document.getElementById('fileInputContainer');
              if (fileInputContainer) {
                fileInputContainer.classList.add('loaded');
              }
              // Hide new drawing button
              const newDrawingButton = document.getElementById('newDrawingButton');
              if (newDrawingButton) {
                newDrawingButton.style.display = 'none';
              }
              const newButtonLabel = newDrawingButton?.parentElement?.querySelector('.file-fab-label');
              if (newButtonLabel) {
                newButtonLabel.style.display = 'none';
              }
            }catch(err){
              console.error('Sample load failed', err);
              alert('Sample load failed: ' + (err && err.message ? err.message : err));
            }finally{
              loadSampleBtn.disabled = false;
              if(label) label.textContent = prevLabel || 'Sample';
            }
          });
        }

        // Manual Init button (debug): try to find and instantiate a viewer constructor
        const initViewerBtn = document.getElementById('initViewerBtn');
        if (initViewerBtn) {
          initViewerBtn.addEventListener('click', () => {
            try {
              const tryInit = () => {
                const snaps = [];
                for (const k of Object.getOwnPropertyNames(window)) {
                  try {
                    const v = window[k];
                    if (typeof v === 'function') {
                      const s = v.toString();
                      if (s.includes('Failed to initialize CAD viewer') || s.includes('this.container=document.getElementById("cad-container")') || s.includes('initialize(){if(!this.isInitialized)')) {
                        snaps.push(k);
                      }
                    }
                  } catch (e) { /* ignore */ }
                }
                console.log('Init candidates:', snaps);
                for (const name of snaps) {
                  try {
                    const C = window[name];
                    const inst = new C();
                    console.log('Initialized viewer via', name, inst);
                    return true;
                  } catch (e) {
                    console.warn('Init failed for', name, e);
                  }
                }
                return false;
              };
              const ok = tryInit();
              if (!ok) console.log('Init did not find a matching constructor.');
            } catch (e) {
              console.warn('Init click handler error', e);
            }
          });
        }
      });
    </script>
    <script>
      // PDF Export functionality
      async function isImageMostlyBlank(dataUrl){
        return new Promise((resolve)=>{
          const img = new Image();
          img.onload = ()=>{
            try{
              const c = document.createElement('canvas');
              c.width = img.width;
              c.height = img.height;
              const ctx = c.getContext('2d');
              ctx.drawImage(img,0,0);
              const stepX = Math.max(1, Math.floor(img.width / 40));
              const stepY = Math.max(1, Math.floor(img.height / 40));
              let sum=0, sumSq=0, count=0;
              const data = ctx.getImageData(0,0,img.width,img.height).data;
              for(let y=0;y<img.height;y+=stepY){
                for(let x=0;x<img.width;x+=stepX){
                  const idx = (y*img.width + x) * 4;
                  const r = data[idx];
                  const g = data[idx+1];
                  const b = data[idx+2];
                  const a = data[idx+3];
                  const brightness = a === 0 ? 255 : (r+g+b)/3;
                  sum += brightness;
                  sumSq += brightness*brightness;
                  count++;
                }
              }
              const avg = sum / Math.max(1,count);
              const variance = (sumSq / Math.max(1,count)) - (avg*avg);
              const stdDev = Math.sqrt(Math.max(0, variance));
              resolve(avg > 250 && stdDev < 4);
            }catch(err){
              console.warn('isImageMostlyBlank failed', err);
              resolve(false);
            }
          };
          img.onerror = ()=> resolve(false);
          img.src = dataUrl;
        });
      }

      const ensureScript = (url, checkFn) => new Promise((resolve,reject)=>{
        if(checkFn && checkFn()) return resolve();
        const s = document.createElement('script');
        s.src = url;
        s.onload = resolve;
        s.onerror = ()=> reject(new Error('Failed to load '+url));
        document.head.appendChild(s);
      });

      document.addEventListener('DOMContentLoaded', () => {
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        if (exportPdfBtn) {
          exportPdfBtn.addEventListener('click', async () => {
            const canvas = document.querySelector('#cad-container canvas');
            if (!canvas) {
              alert('No drawing loaded. Please load a DWG file first.');
              return;
            }
            exportPdfBtn.disabled = true;
            try {
              // Ensure jsPDF is available (we only need jsPDF for PDF generation)
              await ensureScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', ()=> window.jspdf);

              // Try direct canvas export first (fastest and preserves fidelity if possible)
              let imgData = null;
              try {
                imgData = canvas.toDataURL('image/png');
                if (!imgData || !imgData.startsWith('data:image')) imgData = null;
                if (imgData && await isImageMostlyBlank(imgData)) {
                  console.warn('PDF export: canvas toDataURL appears blank, will fallback');
                  imgData = null;
                }
              } catch (e) {
                console.warn('canvas.toDataURL failed:', e);
                imgData = null;
              }

              // If direct toDataURL failed or produced no data, attempt WebGL readPixels
              if (!imgData) {
                try {
                  const gl = canvas.getContext('webgl2') || canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                  if (gl) {
                    const width = canvas.width;
                    const height = canvas.height;
                    const pixels = new Uint8Array(width * height * 4);
                    // Read the current framebuffer
                    gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
                    // Flip Y and copy into ImageData
                    const flipped = new Uint8ClampedArray(width * height * 4);
                    for (let y = 0; y < height; y++) {
                      const srcStart = (height - 1 - y) * width * 4;
                      const dstStart = y * width * 4;
                      flipped.set(pixels.subarray(srcStart, srcStart + width * 4), dstStart);
                    }
                    const tmp = document.createElement('canvas');
                    tmp.width = width;
                    tmp.height = height;
                    const ctx = tmp.getContext('2d');
                    const imageData = new ImageData(flipped, width, height);
                    ctx.putImageData(imageData, 0, 0);
                    imgData = tmp.toDataURL('image/png');
                    if (imgData && await isImageMostlyBlank(imgData)) {
                      console.warn('PDF export: WebGL readPixels capture appears blank, will fallback');
                      imgData = null;
                    }
                  }
                } catch (e) {
                  console.warn('WebGL readPixels export failed:', e);
                }
              }

              // If still no image data, try html2canvas as a last resort
              if (!imgData) {
                // Load html2canvas on demand
                await ensureScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', ()=> window.html2canvas);
                const container = document.getElementById('cad-container') || canvas;
                const canvasImage = await html2canvas(container, { useCORS: true, allowTaint: false, backgroundColor:'#ffffff' });
                imgData = canvasImage.toDataURL('image/png');
              }

              if (!imgData) throw new Error('Unable to capture drawing image. The viewer may be using cross-origin textures or non-readable WebGL state.');

              // Diagnostic: ensure imgData looks like an image data URL and not HTML
              if (typeof imgData === 'string' && imgData.trim().startsWith('<')) {
                console.error('PDF export: captured data appears to be HTML (likely an error page). First 300 chars:', imgData.slice(0,300));
                throw new Error('Captured image data is HTML, not an image. See console for details.');
              }

              // Generate PDF using jsPDF
              const { jsPDF } = window.jspdf;
              const pdf = new jsPDF({ unit: 'mm', format: 'a4' });
              const img = new Image();
              img.src = imgData;
              await new Promise((resolve) => { img.onload = resolve; });

              console.log('PDF export: capture method succeeded, image size px', img.width, img.height);

              // Fit image to A4 while maintaining aspect ratio
              const pageWidth = 210; // mm
              const pageHeight = 297; // mm
              const imgAspect = img.width / img.height;
              // Start by fitting to page width, then scale down if height exceeds page
              let drawWidth = pageWidth;
              let drawHeight = drawWidth / imgAspect;
              if (drawHeight > pageHeight) {
                drawHeight = pageHeight;
                drawWidth = drawHeight * imgAspect;
              }

              console.log('PDF export: image px', img.width, img.height, 'draw mm', drawWidth, drawHeight);

              pdf.addImage(imgData, 'PNG', (pageWidth - drawWidth) / 2, (pageHeight - drawHeight) / 2, drawWidth, drawHeight);
              pdf.save('drawing.pdf');
            } catch (error) {
              console.error('PDF export failed', error);
              alert('PDF export failed: ' + (error && error.message ? error.message : error));
            } finally {
              exportPdfBtn.disabled = false;
            }
          });
        }
      });
    </script>
    <!-- Native viewer handles pan/zoom; custom handlers removed to avoid conflicts -->
  </body>
</html>
