<!-- File: tools/convert.html - DWG/DXF conversion tool UI. -->
<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
	
  <meta name="mobile-web-app-capable" content="yes" />
	<title>Convert DWG/DXF</title>
	<link rel="stylesheet" href="/assets/ui.css?v=20260204_1">
	<style>
		.card{max-width:960px;margin:20px auto;padding:16px}
		.row{display:flex;gap:12px;align-items:center}
		.formats{display:flex;gap:8px;margin:12px 0}
		.outArea{margin-top:12px}
		.loader{width:18px;height:18px;border:3px solid rgba(255,255,255,0.12);border-top-color:var(--neon);border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-left:8px}
		@keyframes spin{to{transform:rotate(360deg)}}
		.hint{color:var(--muted);font-size:13px;margin-top:8px}
		/* Neon-style select and custom dropdown to match site */
		.neonSelect{ padding-right: 40px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24'%3E%3Cpath fill='%23041013' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 10px center; background-size:18px 18px; border-radius:8px; border:none; background: linear-gradient(90deg, var(--neon), var(--neon2)); color:#041013; box-shadow: 0 8px 28px rgba(0,255,231,.12); }
		.customSelect{ position:relative; display:inline-block; }
		.customSelect .selectButton{ width:100%; text-align:left; background: linear-gradient(90deg, var(--neon), var(--neon2)); border:none; padding:8px 12px; color:#041013; font-weight:800; font-size:14px; cursor:pointer; border-radius:12px; box-shadow: 0 8px 28px rgba(0,255,231,.12); }
		.customSelect .selectList{ display:none; position:absolute; left:0; top:calc(100% + 8px); min-width:160px; max-height:300px; overflow:auto; background: linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); border:1px solid rgba(0,255,231,0.08); box-shadow: 0 12px 30px rgba(0,0,0,0.5); border-radius:12px; z-index:9999; padding:8px; list-style:none; margin:0 }
		.customSelect .selectList.open{ display:block }
		.customSelect .selectList li{ padding:12px 14px; border-radius:8px; color:#041013 !important; cursor:pointer; font-weight:700; }
		.customSelect .selectList li:hover{ background: linear-gradient(90deg, rgba(0,255,231,0.06), rgba(57,255,20,0.04)); color:#041013; font-weight:800; }
		.customSelect .selectList li[aria-selected="true"]{ background: linear-gradient(90deg, var(--neon), var(--neon2)); color:#000000; font-weight:900; }
		input[type=file]::-webkit-file-upload-button{ background: linear-gradient(90deg, var(--neon), var(--neon2)); color:#041013; border:none; padding:6px 10px; border-radius:8px; margin-right:8px; }
	  /* touch/tap friendly UI helpers */
	  button, input, select {
	    min-height: 44px;
	    min-width: 44px;
	    font-size: 1.1em;
	    border-radius: 6px;
	  }
	  button:active, .btn:active, .btnPrimary:active {
	    filter: brightness(0.85);
	    box-shadow: 0 0 0 2px #0ff inset;
	  }
	  .cropOverlay, .annotateOverlay, .splitOverlay, .mergeOverlay, .printOverlay {
	    touch-action: none;
	  }
	</style>
</head>
<body>
	<header class="topbar">
		<button onclick="history.back()" class="iconBtn" aria-label="Back">←</button>
		<div class="brand">Convert DWG / DXF</div>
	</header>

	<main class="main">
		<div class="card">
			<h2>Convert DWG / DXF to PDF, SVG or DXF</h2>
			<p class="hint">Upload a .dwg or .dxf file and choose an output format.</p>

			<div class="row" style="margin-top:12px;">
				<label style="flex:1">Files: <input id="fileInput" type="file" accept=".dwg,.dxf" multiple aria-label="Select DWG/DXF files"></label>
				<div style="width:220px">
					<label>Format</label>
					<div class="customSelect neonSelect" id="formatSelect">
						<button type="button" class="selectButton" aria-haspopup="listbox" aria-expanded="false">PDF</button>
						<ul class="selectList" role="listbox">
							<li role="option" data-value="pdf" aria-selected="true">PDF</li>
							<li role="option" data-value="svg">SVG</li>
							<li role="option" data-value="dxf">DXF</li>
						</ul>
					</div>
				</div>
				<button id="btnConvert" class="btnPrimary">Convert Batch</button>
			</div>

			<div id="fileList" style="margin-top:10px" role="status" aria-live="polite"></div>

			<div class="formats" id="advancedOptions" style="margin-top:6px;">
				<label class="muted">Options:</label>
				<label><input type="checkbox" id="optRaster"/> Rasterize complex entities</label>
				<label><input type="checkbox" id="optPreview"/> Show preview when ready</label>
				<label style="margin-left:12px">Paper:
					<div class="customSelect neonSelect" id="paperSelect" style="display:inline-block; min-width:120px;">
						<button type="button" class="selectButton" aria-haspopup="listbox" aria-expanded="false">Auto</button>
						<ul class="selectList" role="listbox">
							<li role="option" data-value="auto" aria-selected="true">Auto</li>
							<li role="option" data-value="A4">A4</li>
							<li role="option" data-value="A3">A3</li>
							<li role="option" data-value="A2">A2</li>
							<li role="option" data-value="A1">A1</li>
							<li role="option" data-value="A0">A0</li>
						</ul>
					</div>
				</label>
				<label style="margin-left:12px">Scale:
					<input id="scaleInput" type="number" min="0.1" step="0.1" value="1" style="width:80px" inputmode="decimal" aria-label="Scale factor">x
				</label>
				<label style="margin-left:12px"><input type="checkbox" id="optLayers"/> Preserve layers</label>
			</div>

			<div class="outArea" id="outArea" role="status" aria-live="polite"></div>
	
		</div>
	</main>

	<script>
		const fileInput = document.getElementById('fileInput');
		const formatSelect = document.getElementById('formatSelect');
		const btnConvert = document.getElementById('btnConvert');
		const outArea = document.getElementById('outArea');

		// Initialize custom select wrappers (value stored on wrapper element)
		function selectCustomOption(elId, value, label){
			const el = document.getElementById(elId);
			if(!el) return;
			el.value = value;
			const btn = el.querySelector('.selectButton'); if(btn) btn.textContent = label;
			const items = el.querySelectorAll('li'); items.forEach(li=> li.removeAttribute('aria-selected'));
			const sel = el.querySelector('li[data-value="'+value+'"]'); if(sel) sel.setAttribute('aria-selected','true');
		}

		function initCustomSelect(elId){
			const el = document.getElementById(elId); if(!el) return;
			const btn = el.querySelector('.selectButton'); const list = el.querySelector('.selectList');
			const options = list.querySelectorAll('li');
			// set initial
			const first = options[0]; if(first){ el.value = first.dataset.value; btn.textContent = first.textContent; first.setAttribute('aria-selected','true'); }
			btn.addEventListener('click', (e)=>{ e.stopPropagation(); const open = list.classList.toggle('open'); btn.setAttribute('aria-expanded', open? 'true':'false'); });
			options.forEach(li=> li.addEventListener('click', (e)=>{ e.stopPropagation(); selectCustomOption(elId, li.dataset.value, li.textContent); list.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }));
			document.addEventListener('click', (e)=>{ if(!el.contains(e.target)){ list.classList.remove('open'); btn.setAttribute('aria-expanded','false'); } });
		}

		// init our custom selects
		initCustomSelect('formatSelect');
		initCustomSelect('paperSelect');

		function showLoader(msg){ outArea.innerHTML = msg + ' <span class="loader"></span>'; }
		function showError(msg){ outArea.innerHTML = '<div class="error">'+msg+'</div>'; }
		function showResult(filename, path){
			const url = path && path.indexOf('/')===0 ? path : ('/storage/exports/' + filename);
			outArea.innerHTML = `<div>Conversion complete: <a href="${url}" target="_blank">${filename}</a></div>`;
			if(formatSelect.value==='svg' || formatSelect.value==='pdf'){
				const preview = document.createElement('div'); preview.style.marginTop='12px';
				if(formatSelect.value==='svg'){
					const img = document.createElement('object'); img.type='image/svg+xml'; img.data = url; img.style.width='100%'; img.style.height='600px'; preview.appendChild(img);
				} else {
					const iframe = document.createElement('iframe'); iframe.src = url; iframe.style.width='100%'; iframe.style.height='600px'; preview.appendChild(iframe);
				}
				outArea.appendChild(preview);
			}
		}

		// Render selected files list
		function renderFileList(){
			const list = document.getElementById('fileList'); list.innerHTML='';
			const files = fileInput.files || [];
			if(files.length===0){ list.innerHTML='<div class="muted">No files selected</div>'; return; }
			const ul = document.createElement('div'); ul.style.display='flex'; ul.style.flexDirection='column'; ul.style.gap='6px';
			for(let i=0;i<files.length;i++){
				const f = files[i];
				const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px';
				const name = document.createElement('div'); name.textContent = f.name; name.style.flex='1';
				const status = document.createElement('div'); status.textContent = 'Queued'; status.className='muted'; status.style.minWidth='120px';
				row.appendChild(name); row.appendChild(status); ul.appendChild(row);
			}
			list.appendChild(ul);
		}

		fileInput.addEventListener('change', renderFileList);

		async function convertFileXHR(file, opts, statusCallback){
			return new Promise((resolve,reject)=>{
				const xhr = new XMLHttpRequest();
				xhr.open('POST', '/api/convert_dwg.php');
				xhr.onload = function(){
					let txt = xhr.responseText;
					try{ const j = JSON.parse(txt); if(xhr.status>=200 && xhr.status<300 && j.ok) return resolve(j); return reject(new Error(j.error||('HTTP '+xhr.status)) ); }catch(e){ return reject(new Error('Invalid server response: '+txt)); }
				};
				xhr.onerror = function(){ reject(new Error('Network error')); };
				xhr.upload.onprogress = function(ev){ if(ev.lengthComputable) statusCallback(Math.round((ev.loaded/ev.total)*100)); };
				const fd = new FormData(); fd.append('file', file); fd.append('format', opts.format); fd.append('paper', opts.paper); fd.append('scale', opts.scale); if(opts.raster) fd.append('raster', '1'); if(opts.layers) fd.append('layers','1');
				xhr.send(fd);
			});
		}

		btnConvert.addEventListener('click', async ()=>{
			const files = fileInput.files || [];
			if(!files || files.length===0) return showError('Choose one or more DWG/DXF files');
			const fm = formatSelect.value || 'pdf';
			const opts = { format: fm, raster: document.getElementById('optRaster').checked, preview: document.getElementById('optPreview').checked, paper: document.getElementById('paperSelect').value, scale: document.getElementById('scaleInput').value || '1', layers: document.getElementById('optLayers').checked };
			outArea.innerHTML = '';
			const list = document.getElementById('fileList');
			const rows = list.querySelectorAll('div > div');
			// build status map
			const statusElems = [];
			const names = [];
			const items = list.querySelectorAll('div > div');
			let idx=0;
			for(let i=0;i<files.length;i++){
				const f = files[i];
				// create dedicated status row
				const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between'; row.style.gap='8px'; row.style.padding='6px'; row.style.border='1px solid rgba(255,255,255,0.04)'; row.style.borderRadius='8px';
				const left = document.createElement('div'); left.textContent = f.name; left.style.flex='1';
				const right = document.createElement('div'); right.textContent = 'Queued'; right.style.minWidth='140px';
				row.appendChild(left); row.appendChild(right); outArea.appendChild(row); statusElems.push(right); names.push(f.name);
			}

			// sequentially upload
			for(let i=0;i<files.length;i++){
				const f = files[i]; const statusEl = statusElems[i]; statusEl.textContent = 'Uploading...';
				try{
					const res = await convertFileXHR(f, opts, (p)=>{ statusEl.textContent = 'Uploading: '+p+'%'; });
					statusEl.innerHTML = `Done — <a href="${res.path||('/storage/exports/'+res.filename)}" target="_blank">${res.filename}</a>`;
					if(opts.preview && (opts.format==='svg' || opts.format==='pdf')){
						const place = document.createElement('div'); place.style.marginTop='8px';
						if(opts.format==='svg'){ const obj=document.createElement('object'); obj.type='image/svg+xml'; obj.data=res.path||('/storage/exports/'+res.filename); obj.style.width='100%'; obj.style.height='400px'; place.appendChild(obj); }
						else { const iframe=document.createElement('iframe'); iframe.src=res.path||('/storage/exports/'+res.filename); iframe.style.width='100%'; iframe.style.height='400px'; place.appendChild(iframe); }
						outArea.appendChild(place);
					}
				}catch(err){ statusEl.textContent = 'Error: '+err.message; console.error('convert error', err); }
			}
		});
	</script>
</body>
</html>


